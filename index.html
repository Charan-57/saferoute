<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>

<title>SafeRoute AI</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
--bg:#f6f7fb;
--card:#ffffff;
--text:#111;
--primary:linear-gradient(135deg,#4f46e5,#0ea5e9);
}

[data-theme="dark"]{
--bg:#0f172a;
--card:#020617;
--text:#f8fafc;
}

*{box-sizing:border-box;font-family:Inter}

body{
margin:0;
background:var(--bg);
color:var(--text);
transition:.3s;
}

#app{
display:grid;
grid-template-columns:340px 1fr;
height:100vh;
}

/* SIDEBAR */

#sidebar{
padding:20px;
background:var(--card);
box-shadow:0 0 30px rgba(0,0,0,.1);
display:flex;
flex-direction:column;
gap:14px;
}

/* HEADER */

.brand{
display:flex;
align-items:center;
gap:10px;
font-weight:700;
font-size:20px;
}

.logo{
width:34px;
height:34px;
border-radius:8px;
background:var(--primary);
display:flex;
align-items:center;
justify-content:center;
color:white;
font-weight:700;
}

/* INPUTS */

input,textarea,select{
width:100%;
padding:10px;
border-radius:8px;
border:1px solid #ddd;
background:transparent;
color:var(--text);
}

textarea{resize:none;height:70px}

/* BUTTONS */

button{
padding:10px;
border:none;
border-radius:10px;
background:var(--primary);
color:white;
font-weight:600;
cursor:pointer;
transition:.2s;
}

button:hover{opacity:.9;transform:scale(1.01)}

.secondary{
background:#e5e7eb;
color:black;
}

[data-theme="dark"] .secondary{
background:#1e293b;
color:white;
}

/* MAP */

#map{
height:100vh;
}

/* REPORT CARD */

#reportPanel{
display:none;
background:var(--card);
padding:12px;
border-radius:12px;
box-shadow:0 10px 25px rgba(0,0,0,.15);
}

/* TOGGLE */

.toggle{
cursor:pointer;
padding:6px 10px;
border-radius:8px;
background:#eee;
font-size:12px;
text-align:center;
}

[data-theme="dark"] .toggle{
background:#1e293b;
}

.small{font-size:12px;opacity:.7}
</style>
</head>

<body>

<div id="app">

<div id="sidebar">

<div class="brand">
<div class="logo">SR</div>
SafeRoute AI
</div>

<div class="toggle" onclick="toggleTheme()">ğŸŒ— Light/Dark mode</div>

<input id="src" placeholder="ğŸ“ Source">
<input id="dst" placeholder="ğŸ¯ Destination">

<button onclick="route()">Find Safe Route</button>
<button class="secondary" onclick="toggleReport()">Report / Comment</button>
<button class="secondary" onclick="heat()">Crime Heatmap</button>

<div id="reportPanel">

<div class="small">Click map to select area</div>

<input id="area" placeholder="Area">

<select id="rtype">
<option value="">Select Report Type</option>

<option value="theft">ğŸš¨ Theft / Robbery</option>
<option value="harassment">ğŸ§ Harassment</option>
<option value="rash-driving">ğŸš— Rash Driving</option>
<option value="accident">ğŸš¦ Traffic Accident</option>
<option value="drunk-driving">ğŸ’Š Drunk Driving</option>
<option value="suspicious">ğŸ‘¥ Suspicious Activity</option>
<option value="assault">ğŸ§‘â€ğŸ¤â€ğŸ§‘ Assault / Fight</option>
<option value="snatching">ğŸ”ª Chain Snatching</option>
<option value="vehicle-break">ğŸ…¿ï¸ Vehicle Break-in</option>

<option value="comment">ğŸ’¬ General Comment</option>
</select>


<textarea id="msg" placeholder="Describe incident..."></textarea>

<button onclick="submitReport()">Submit Report</button>

</div>

<div class="small">
AI + OpenStreetMap + Community Safety
</div>

</div>

<div id="map"></div>

</div>

<script>

document.documentElement.setAttribute("data-theme","light");

function toggleTheme(){
let t=document.documentElement.getAttribute("data-theme");
document.documentElement.setAttribute("data-theme",t=="dark"?"light":"dark");
}

const map=L.map("map").setView([17.385,78.4867],8);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let layers=[],heatLayer;
let clickedPoint=null;
window.crimeMarkers=[];

map.on("click",e=>{
clickedPoint=e.latlng;
area.value=`${e.latlng.lat.toFixed(4)},${e.latlng.lng.toFixed(4)}`;
});

function toggleReport(){
reportPanel.style.display=reportPanel.style.display=="block"?"none":"block";
}

async function route(){

layers.forEach(l=>map.removeLayer(l));
layers=[];

window.crimeMarkers.forEach(m=>map.removeLayer(m));
window.crimeMarkers=[];

let r=await fetch("/route",{method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
source:src.value,
destination:dst.value,
time:"21:00"
})});

let j=await r.json();

j.routes.forEach((x,i)=>{
let c=x.polyline.map(p=>[p[1],p[0]]);
layers.push(L.polyline(c,{color:i==0?"#22c55e":"#ef4444",weight:5}).addTo(map));
});

map.fitBounds(layers[0].getBounds());

let cr=await fetch("/crimes");
let cj=await cr.json();

cj.forEach(p=>{
let m=L.circleMarker([p.lat,p.lon],{
radius:7,
color:"#ef4444",
fillColor:"#ef4444",
fillOpacity:.8
}).addTo(map).bindPopup("ğŸš¨ Reported Area");
window.crimeMarkers.push(m);
});
}

async function submitReport(){

if(!clickedPoint){
alert("Click on map first");
return;
}

await fetch("/report",{method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
lat:clickedPoint.lat,
lon:clickedPoint.lng,
type:msg.value
})});

alert("Report submitted");
msg.value="";
}

async function heat(){
let r=await fetch("/heatmap");
let j=await r.json();
if(heatLayer) map.removeLayer(heatLayer);
heatLayer=L.heatLayer(j,{radius:40,blur:20}).addTo(map);
}

</script>

</body>
</html>
